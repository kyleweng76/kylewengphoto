<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kylewengphoto攝情</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="apple-touch-icon" href="weblogo.png">
    <link rel="shortcut icon" href="weblogo.png">

    <style>
        :root {
            --bg-color: #000000;
            --text-color: #ffffff;
            --accent-color: #333;
            --active-color: #fff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "San Francisco", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-x: none; 
        }

        /* 標題與導航 */
        header {
            padding-top: 30px;
            padding-bottom: 10px;
            text-align: center;
            background: rgba(0,0,0,0.95);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        header h1 {
            margin: 0 0 15px 0;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 40px; 
        }

        .site-logo {
            height: 36px;
            width: auto;
            display: block;
        }
        
        .fallback-title {
            display: none;
            font-weight: 300;
            letter-spacing: 2px;
            font-size: 1.2rem;
            text-transform: uppercase;
        }

        .back-btn {
            position: absolute;
            left: 20px;
            top: 35px;
            font-size: 1rem;
            color: #ccc;
            cursor: pointer;
            display: none;
            padding: 10px;
            margin-left: -10px;
            z-index: 60;
        }

        /* --- 分類標籤 (Tabs) --- */
        .category-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding-bottom: 15px;
            overflow-x: auto;
            white-space: nowrap;
            -ms-overflow-style: none;  
            scrollbar-width: none;  
        }
        .category-tabs::-webkit-scrollbar { display: none; }

        .tab-btn {
            background: transparent;
            border: 1px solid #444;
            color: #888;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: var(--active-color);
            color: black;
            border-color: var(--active-color);
            font-weight: 500;
        }

        /* --- 相簿列表 --- */
        .album-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            animation: fadeIn 0.5s ease;
        }

        .album-card {
            position: relative;
            aspect-ratio: 16 / 9;
            background: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .album-card:active { transform: scale(0.98); }

        .album-card img {
            width: 100%; height: 100%;
            object-fit: cover;
            opacity: 0.7;
            transition: opacity 0.3s, transform 0.5s;
        }

        .album-card:hover img { 
            opacity: 1; 
            transform: scale(1.03); 
        }

        .album-title {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            font-size: 1.1rem;
            font-weight: 500;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* --- 內頁：照片牆 --- */
        .gallery-view {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            padding-bottom: 50px;
        }

        @media (min-width: 768px) {
            .gallery-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1 / 1;
            overflow: hidden;
            background: #111;
            cursor: pointer;
        }

        .photo-item img {
            width: 100%; height: 100%;
            object-fit: cover;
            opacity: 0; 
            transition: opacity 0.5s ease;
        }
        .photo-item img.loaded { opacity: 1; }

        /* --- Lightbox 修正版 --- */
        .lightbox {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.98);
            z-index: 1000;
            /* 改為 Flex Column 佈局，確保上下不會重疊 */
            display: flex; /* 這裡預設要是 flex，但透過 active class 控制顯示 */
            flex-direction: column;
            justify-content: space-between; /* 內容上下撐開 */
            align-items: center;
            padding: 20px 0; /* 上下留白 */
            box-sizing: border-box;
            
            visibility: hidden; /* 預設隱藏 */
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s;

            user-select: none; 
            -webkit-user-select: none;
        }

        .lightbox.active { 
            visibility: visible;
            opacity: 1;
        }
        
        /* 圖片容器：佔據中間所有剩餘空間 */
        .lightbox-content {
            flex: 1;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .lightbox img {
            max-width: 100%; 
            /* ★ 關鍵修正：高度扣掉上下保留區 (Close btn + Action bar) */
            /* 100dvh 代表裝置的可視高度，比 100vh 在手機上更準確 */
            max-height: calc(100dvh - 140px); 
            object-fit: contain;
            
            /* 預設狀態 */
            opacity: 1;
            transform: translateX(0);
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s ease;
        }

        /* ★ 新增：滑動動畫樣式 */
        /* 往左滑 (下一張)：舊圖往左出，新圖從右入 */
        .anim-slide-left-out { transform: translateX(-20%) scale(0.9); opacity: 0 !important; }
        .anim-slide-left-in  { animation: slideInRight 0.3s cubic-bezier(0.25, 1, 0.5, 1) forwards; }

        /* 往右滑 (上一張)：舊圖往右出，新圖從左入 */
        .anim-slide-right-out { transform: translateX(20%) scale(0.9); opacity: 0 !important; }
        .anim-slide-right-in  { animation: slideInLeft 0.3s cubic-bezier(0.25, 1, 0.5, 1) forwards; }

        @keyframes slideInRight {
            from { transform: translateX(30px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInLeft {
            from { transform: translateX(-30px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* 底部操作區：固定高度，避免被圖片壓住 */
        .action-bar { 
            height: 80px; /* 固定高度區 */
            width: 100%;
            display: flex; 
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1001;
            background: linear-gradient(transparent, rgba(0,0,0,0.8)); /* 底部稍微漸層黑，增加對比 */
            flex-shrink: 0; /* 防止被壓縮 */
        }

        .btn {
            background: rgba(255,255,255,0.15);
            color: white; padding: 12px 28px;
            border-radius: 30px; text-decoration: none;
            font-size: 15px;
            font-weight: 500;
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(5px);
            display: flex; align-items: center; gap: 8px;
            transition: background 0.2s;
        }
        .btn:active { background: rgba(255,255,255,0.3); transform: scale(0.98); }
        
        .close-btn {
            position: absolute; top: 10px; right: 20px;
            font-size: 36px; padding: 10px; cursor: pointer;
            z-index: 1002;
            color: white;
            opacity: 0.8;
            height: 50px; width: 50px;
            display: flex; align-items: center; justify-content: center;
        }

        /* 左右切換按鈕 (電腦版顯示) */
        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            padding: 20px;
            cursor: pointer;
            color: white;
            font-size: 24px;
            background: rgba(0,0,0,0.3);
            border-radius: 50%;
            width: 50px; height: 50px;
            display: none; 
            align-items: center;
            justify-content: center;
            z-index: 1002;
            transition: background 0.2s;
        }
        
        .nav-btn:hover { background: rgba(255,255,255,0.2); }
        .nav-btn.prev { left: 20px; }
        .nav-btn.next { right: 20px; }

        @media (min-width: 768px) {
            .nav-btn { display: flex; } 
        }

        .loading { text-align: center; padding: 40px; color: #666; width: 100%; grid-column: 1 / -1; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>

    <header>
        <div id="back-btn" class="back-btn" onclick="goHome()">←</div>
        
        <h1 onclick="goHome()">
            <img src="kw_web_white_s.png" alt="KYLE PHOTO" class="site-logo" onerror="this.style.display='none'; document.getElementById('text-logo').style.display='block';">
            <span id="text-logo" class="fallback-title">KYLE PHOTO</span>
        </h1>
        
        <div id="category-tabs" class="category-tabs">
            <button class="tab-btn active" onclick="filterAlbums('all')">全部 All</button>
            <button class="tab-btn" onclick="filterAlbums('portrait')">形象寫真</button>
            <button class="tab-btn" onclick="filterAlbums('event')">活動紀實</button>
        </div>
    </header>

    <div id="home-view" class="album-list"></div>

    <div id="gallery-view" class="gallery-view">
        <div id="gallery-grid" class="gallery-grid"></div>
    </div>

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox">
        <div class="close-btn" onclick="closeLightbox()">&times;</div>
        
        <div class="nav-btn prev" onclick="changePhoto(-1)">&#10094;</div>
        <div class="nav-btn next" onclick="changePhoto(1)">&#10095;</div>

        <!-- 包一個容器來控制版面，避免圖片亂跑 -->
        <div class="lightbox-content">
            <img id="lightbox-img" src="" alt="">
        </div>

        <div class="action-bar">
            <a id="download-btn" href="#" target="_blank" class="btn" download>
                <span>↓</span> 下載原始檔 / Download Original
            </a>
            <p style="font-size: 12px; color: #888; margin: 8px 0 0 0;">iPhone 請點擊後長按儲存</p>
        </div>
    </div>

    <script>
        // ================= 設定區 =================
        const API_KEY = 'f26141b4efcea9ac125fd95bf777eb55'; 
        const USER_ID = '135451339@N02'; 

        const EVENT_KEYWORDS = [
            'Pride', 'Parade', 'Championship', 'Championshop', 
            'Day', '1st', '2nd', '3rd', '活動', '龍舟賽', '感恩會', 
            '晚會', '錦標賽', '競賽', '發表會', '遊行', '嘉年華', 
            '文化祭', '文化季', '角力', '田徑', '派對', '驕傲月', 
            '跨年', '法案', '現場', '音樂會', '小蜜蜂', '平權', 
            '國慶', '龍舟隊', '選拔', '練習', '屆', '路跑', '站出來'
        ];
        // ==========================================

        let cachedAlbums = [];
        let currentFilter = 'all';
        let currentAlbumPhotos = []; 
        let currentPhotoIndex = 0;

        const homeView = document.getElementById('home-view');
        const galleryView = document.getElementById('gallery-view');
        const galleryGrid = document.getElementById('gallery-grid');
        const backBtn = document.getElementById('back-btn');
        const categoryTabs = document.getElementById('category-tabs');

        function safePushState(data, title, url) {
            try { window.history.pushState(data, title, url); } 
            catch (e) { console.warn('Preview mode: pushState disabled'); }
        }

        function init() {
            const params = new URLSearchParams(window.location.search);
            const albumId = params.get('album');
            
            if (albumId) {
                loadAlbumPhotos(albumId);
            } else {
                fetchAlbumsAndRender();
            }
        }

        async function fetchAlbumsAndRender() {
            homeView.style.display = 'grid';
            galleryView.style.display = 'none';
            backBtn.style.display = 'none';
            categoryTabs.style.display = 'flex'; 

            if (cachedAlbums.length > 0) {
                filterAlbums(currentFilter);
                return;
            }

            homeView.innerHTML = '<div class="loading">正在整理相簿...</div>';

            const url = `https://www.flickr.com/services/rest/?method=flickr.photosets.getList&api_key=${API_KEY}&user_id=${USER_ID}&primary_photo_extras=url_m,url_o&format=json&nojsoncallback=1`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.stat !== 'ok') throw new Error(data.message);

                cachedAlbums = data.photosets.photoset.map(set => {
                    const cover = set.primary_photo_extras?.url_m || set.primary_photo_extras?.url_o || '';
                    const title = set.title._content;
                    
                    let type = 'portrait';
                    if (EVENT_KEYWORDS.some(keyword => title.toLowerCase().includes(keyword.toLowerCase()))) {
                        type = 'event';
                    }

                    return { id: set.id, title: title, cover: cover, type: type };
                });

                filterAlbums('all'); 

            } catch (error) {
                console.error(error);
                homeView.innerHTML = `<div class="loading">載入失敗<br><small>${error.message}</small></div>`;
            }
        }

        function filterAlbums(type) {
            currentFilter = type;
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            if(type === 'all') buttons[0].classList.add('active');
            if(type === 'portrait') buttons[1].classList.add('active');
            if(type === 'event') buttons[2].classList.add('active');

            let filteredData = (type === 'all') ? cachedAlbums : cachedAlbums.filter(album => album.type === type);
            renderAlbumList(filteredData);
        }

        function renderAlbumList(albums) {
            homeView.innerHTML = '';
            if (albums.length === 0) {
                homeView.innerHTML = '<div class="loading">此分類暫無相簿</div>';
                return;
            }
            albums.forEach(album => {
                const coverImg = album.cover || 'https://placehold.co/600x400/333/FFF?text=No+Cover';
                const card = document.createElement('div');
                card.className = 'album-card';
                card.innerHTML = `<img src="${coverImg}" loading="lazy" alt="${album.title}"><div class="album-title">${album.title}</div>`;
                card.onclick = () => {
                    const newUrl = `?album=${album.id}`;
                    safePushState({path: newUrl}, '', newUrl);
                    loadAlbumPhotos(album.id);
                };
                homeView.appendChild(card);
            });
        }

        async function loadAlbumPhotos(photosetId) {
            homeView.style.display = 'none';
            galleryView.style.display = 'block';
            backBtn.style.display = 'block';
            categoryTabs.style.display = 'none';
            galleryGrid.innerHTML = '<div class="loading">載入照片中...</div>';

            const url = `https://www.flickr.com/services/rest/?method=flickr.photosets.getPhotos&api_key=${API_KEY}&photoset_id=${photosetId}&user_id=${USER_ID}&extras=url_q,url_l,url_o&format=json&nojsoncallback=1`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.stat !== 'ok') throw new Error(data.message);

                galleryGrid.innerHTML = ''; 
                document.title = data.photoset.title + " | Kyle";
                
                currentAlbumPhotos = [];

                data.photoset.photo.forEach((photo, index) => {
                    const thumbUrl = photo.url_q || photo.url_m; 
                    const previewUrl = photo.url_l || photo.url_o || photo.url_m;
                    const downloadUrl = photo.url_o || photo.url_l;
                    
                    if(!thumbUrl) return;

                    currentAlbumPhotos.push({
                        preview: previewUrl,
                        download: downloadUrl,
                        title: photo.title
                    });

                    const div = document.createElement('div');
                    div.className = 'photo-item';
                    div.innerHTML = `<img src="${thumbUrl}" loading="lazy" onload="this.classList.add('loaded')">`;
                    
                    div.onclick = () => openLightbox(index);
                    galleryGrid.appendChild(div);
                });

            } catch (error) {
                console.error(error);
                galleryGrid.innerHTML = `<div class="loading">無法載入照片<br><small>${error.message}</small></div>`;
            }
        }

        function goHome() {
            const newUrl = window.location.pathname; 
            safePushState({path: newUrl}, '', newUrl);
            homeView.style.display = 'grid';
            galleryView.style.display = 'none';
            backBtn.style.display = 'none';
            categoryTabs.style.display = 'flex'; 
            document.title = "Kyle's Gallery";
        }

        // ================= Lightbox 滑動動畫邏輯 =================
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        const downloadBtn = document.getElementById('download-btn');

        function openLightbox(index) {
            currentPhotoIndex = index;
            // 歸零動畫 class
            lightboxImg.className = '';
            updateLightboxContent(false); // false = 不播動畫 (第一張直接顯示)
            lightbox.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function updateLightboxContent(animate = false, direction = 1) {
            const photo = currentAlbumPhotos[currentPhotoIndex];
            
            // 下載連結直接更新
            downloadBtn.href = photo.download;

            if (animate) {
                // 如果需要動畫：先加上「移出」的動畫
                // direction 1 = 下一張 (往左滑)
                // direction -1 = 上一張 (往右滑)
                
                // 1. 先把舊圖 fade out / slide out
                lightboxImg.className = direction === 1 ? 'anim-slide-left-out' : 'anim-slide-right-out';

                // 2. 短暫延遲後換圖，並 slide in
                setTimeout(() => {
                    lightboxImg.src = photo.preview;
                    lightboxImg.className = direction === 1 ? 'anim-slide-left-in' : 'anim-slide-right-in';
                }, 200); // 這個時間要配合 CSS transition
                
            } else {
                // 不需要動畫 (剛打開時)
                lightboxImg.src = photo.preview;
                lightboxImg.className = ''; 
            }

            // 預載
            preloadImage(currentPhotoIndex + 1);
            preloadImage(currentPhotoIndex - 1);
        }

        function preloadImage(index) {
            if (index >= 0 && index < currentAlbumPhotos.length) {
                const img = new Image();
                img.src = currentAlbumPhotos[index].preview;
            }
        }

        function changePhoto(direction) {
            let newIndex = currentPhotoIndex + direction;
            if (newIndex < 0) return; 
            if (newIndex >= currentAlbumPhotos.length) return; 

            currentPhotoIndex = newIndex;
            // 傳入 true (要動畫) 和方向
            updateLightboxContent(true, direction);
        }

        function closeLightbox() {
            lightbox.classList.remove('active');
            lightboxImg.src = '';
            lightboxImg.className = ''; // 清除動畫
            document.body.style.overflow = '';
        }

        lightbox.addEventListener('click', (e) => {
            // 點擊背景 (不是圖片也不是按鈕) 時關閉
            if (e.target === lightbox || e.target.classList.contains('lightbox-content')) {
                closeLightbox();
            }
        });

        // --- 手勢滑動 ---
        let touchStartX = 0;
        let touchEndX = 0;

        lightbox.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, {passive: true});

        lightbox.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, {passive: true});

        function handleSwipe() {
            const swipeThreshold = 50; 
            const diff = touchStartX - touchEndX;

            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    changePhoto(1); // 左滑 = 下一張
                } else {
                    changePhoto(-1); // 右滑 = 上一張
                }
            }
        }
        
        document.addEventListener('keydown', (e) => {
            if (!lightbox.classList.contains('active')) return;
            if (e.key === 'ArrowLeft') changePhoto(-1);
            if (e.key === 'ArrowRight') changePhoto(1);
            if (e.key === 'Escape') closeLightbox();
        });

        window.onpopstate = function(event) {
            init();
        };

        init();
    </script>
</body>
</html>