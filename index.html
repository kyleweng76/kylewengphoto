<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kylewengphoto攝情</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="apple-touch-icon" href="weblogo.png">
    <link rel="shortcut icon" href="weblogo.png">

    <style>
        /* ★ 全域設定 */
        * { box-sizing: border-box; }

        :root {
            --bg-color: #000000;
            --text-color: #ffffff;
            --accent-color: #333;
            --active-color: #fff;
            --card-bg: #111;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "San Francisco", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-x: none; 
        }

        /* 標題與導航 */
        header {
            padding-top: 30px;
            padding-bottom: 10px;
            text-align: center;
            background: rgba(0,0,0,0.95);
            position: sticky;
            top: 0;
            z-index: 50;
            border-bottom: 1px solid #222;
        }
        
        header h1 {
            margin: 0 0 10px 0; 
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 40px; 
        }

        .site-logo { height: 36px; width: auto; display: block; }
        .fallback-title { display: none; font-weight: 300; letter-spacing: 2px; font-size: 1.2rem; text-transform: uppercase; }

        .back-btn {
            position: absolute; left: 20px; top: 35px;
            font-size: 1rem; color: #ccc; cursor: pointer;
            display: none; padding: 10px; margin-left: -10px; z-index: 60;
        }

        .social-links {
            display: flex; justify-content: center; gap: 24px;
            margin-bottom: 15px; transition: opacity 0.3s;
        }

        .social-icon {
            color: #888; transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center;
        }
        .social-icon:hover { color: #fff; transform: scale(1.1); }
        .social-icon svg { width: 20px; height: 20px; fill: currentColor; }

        /* 分類標籤 */
        .category-tabs {
            display: flex; justify-content: center; gap: 10px;
            padding-bottom: 15px; overflow-x: auto;
            white-space: nowrap; -ms-overflow-style: none; scrollbar-width: none;
        }
        .category-tabs::-webkit-scrollbar { display: none; }

        .tab-btn {
            background: transparent; border: 1px solid #444; color: #888;
            padding: 6px 16px; border-radius: 20px; font-size: 0.9rem;
            cursor: pointer; transition: all 0.3s;
        }
        .tab-btn.active {
            background: var(--active-color); color: black;
            border-color: var(--active-color); font-weight: 500;
        }

        /* 內容容器 */
        #home-view {
            padding: 20px; margin: 0 auto; animation: fadeIn 0.5s ease;
            padding-bottom: 80px; display: flex; flex-direction: column;
            align-items: center; gap: 40px; max-width: 800px; 
        }

        #home-view.photostream-mode {
            display: grid; max-width: 100%; padding: 0; 
            grid-template-columns: repeat(2, 1fr); gap: 1px;
        }

        @media (min-width: 600px) { #home-view.photostream-mode { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 900px) { #home-view.photostream-mode { grid-template-columns: repeat(4, 1fr); } }
        @media (min-width: 1200px) { #home-view.photostream-mode { grid-template-columns: repeat(5, 1fr); } }
        @media (min-width: 1600px) { #home-view.photostream-mode { grid-template-columns: repeat(6, 1fr); } }

        .stream-item {
            position: relative; cursor: pointer; overflow: hidden;
            background: #111; aspect-ratio: 1 / 1;
        }
        .stream-img {
            width: 100%; height: 100%; object-fit: cover;
            display: block; transition: opacity 0.5s ease; opacity: 0; 
        }
        .stream-img.loaded { opacity: 1; }

        /* 相簿列表卡片 */
        .feed-card {
            background: var(--card-bg); border-radius: 12px; overflow: hidden;
            width: 100%; display: flex; flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5); 
        }
        .feed-img-container {
            width: 100%; min-height: 200px; background: #222;
            overflow: hidden; cursor: pointer; position: relative;
        }
        .feed-img {
            width: 100%; height: auto; display: block; transition: transform 0.5s ease;
        }
        .feed-img-container:hover .feed-img { transform: scale(1.02); }
        .feed-content {
            padding: 24px 20px; display: flex; flex-direction: column; align-items: flex-start;
        }
        .feed-title {
            font-size: 1.4rem; font-weight: 600; margin: 0 0 12px 0;
            line-height: 1.3; color: #fff;
        }
        .feed-desc {
            font-size: 1rem; color: #bbb; line-height: 1.6;
            margin-bottom: 20px; white-space: pre-line; width: 100%;
        }
        .enter-btn {
            background: transparent; color: var(--active-color);
            border: 1px solid rgba(255,255,255,0.3); padding: 10px 24px;
            border-radius: 30px; font-size: 0.95rem; cursor: pointer;
            transition: all 0.2s; text-decoration: none;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .enter-btn:hover { background: rgba(255,255,255,0.1); border-color: #fff; }
        .enter-btn:active { transform: scale(0.98); }

        /* 內頁 Grid */
        .gallery-view { display: none; animation: fadeIn 0.3s ease; }
        .gallery-grid {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 1px; padding-bottom: 50px;
        }
        @media (min-width: 600px) { .gallery-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 900px) { .gallery-grid { grid-template-columns: repeat(4, 1fr); } }
        @media (min-width: 1200px) { .gallery-grid { grid-template-columns: repeat(5, 1fr); } }

        .photo-item {
            position: relative; aspect-ratio: 1 / 1; overflow: hidden;
            background: #111; cursor: pointer;
        }
        .photo-item img {
            width: 100%; height: 100%; object-fit: cover;
            opacity: 0; transition: opacity 0.5s ease;
        }
        .photo-item img.loaded { opacity: 1; }

        /* Lightbox */
        .lightbox {
            display: block; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: #000;
            z-index: 1000; padding: 0; visibility: hidden; opacity: 0;
            pointer-events: none; transition: opacity 0.3s ease, visibility 0.3s;
            user-select: none; -webkit-user-select: none;
        }
        .lightbox.active { visibility: visible; opacity: 1; pointer-events: auto; }
        .lightbox-content {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center; overflow: hidden; 
        }
        .lightbox-img {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: contain; padding: 0; transform: translate3d(0, 0, 0);
            will-change: transform, opacity; transition: transform 0.3s ease;
        }
        
        .slide-next-enter { animation: slideInFromRight 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .slide-next-exit  { animation: slideOutToLeft 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .slide-prev-enter { animation: slideInFromLeft 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .slide-prev-exit  { animation: slideOutToRight 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

        @keyframes slideInFromRight { from { transform: translate3d(100%, 0, 0); } to { transform: translate3d(0, 0, 0); } }
        @keyframes slideOutToLeft { from { transform: translate3d(0, 0, 0); opacity: 1; } to { transform: translate3d(-100%, 0, 0); opacity: 0; } }
        @keyframes slideInFromLeft { from { transform: translate3d(-100%, 0, 0); } to { transform: translate3d(0, 0, 0); } }
        @keyframes slideOutToRight { from { transform: translate3d(0, 0, 0); opacity: 1; } to { transform: translate3d(100%, 0, 0); opacity: 0; } }

        .action-bar { 
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 30px 20px 40px; display: flex; justify-content: center;
            align-items: center; flex-direction: column; z-index: 1001;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.6) 60%, transparent 100%); 
            pointer-events: none; 
        }
        .action-bar a { pointer-events: auto; }

        .btn {
            background: rgba(255,255,255,0.2); color: white; padding: 12px 28px;
            border-radius: 30px; text-decoration: none; font-size: 15px; font-weight: 500;
            border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px);
            display: flex; align-items: center; gap: 8px;
            transition: background 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .btn:active { background: rgba(255,255,255,0.4); transform: scale(0.98); }
        
        .close-btn {
            position: absolute; top: 15px; right: 15px; font-size: 32px; padding: 10px;
            cursor: pointer; z-index: 1002; color: white; opacity: 0.8;
            height: 44px; width: 44px; display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.3); border-radius: 50%; backdrop-filter: blur(5px);
        }

        .nav-btn {
            position: absolute; top: 50%; transform: translateY(-50%); padding: 20px;
            cursor: pointer; color: white; font-size: 24px;
            background: rgba(0,0,0,0.3); border-radius: 50%;
            width: 50px; height: 50px; display: none; align-items: center; justify-content: center;
            z-index: 1002; transition: background 0.2s;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.2); }
        .nav-btn.prev { left: 20px; } .nav-btn.next { right: 20px; }
        @media (min-width: 768px) { .nav-btn { display: flex; } }

        /* Age & PWA Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            padding: 20px; opacity: 0; visibility: hidden;
            transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal-box {
            background: #1a1a1a; border: 1px solid #333;
            border-radius: 16px; padding: 30px 20px;
            width: 100%; max-width: 400px; text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        .modal-title { font-size: 1.4rem; font-weight: 600; margin-bottom: 15px; color: #fff; }
        /* 讓 SVG 圖示和文字對齊 */
        .modal-text { font-size: 1rem; color: #bbb; margin-bottom: 30px; line-height: 1.6; }
        .inline-icon { display: inline-block; vertical-align: text-bottom; margin: 0 2px; }
        
        .modal-buttons { display: flex; gap: 10px; justify-content: center; flex-direction: column; }
        .modal-btn {
            padding: 12px; border-radius: 8px; font-size: 1rem; font-weight: 500;
            cursor: pointer; border: none; transition: background 0.2s;
        }
        .modal-btn.primary { background: #fff; color: #000; }
        .modal-btn.primary:active { background: #ddd; }
        .modal-btn.secondary { background: transparent; color: #888; border: 1px solid #333; }
        .modal-btn.secondary:active { color: #fff; border-color: #fff; }

        .loading { text-align: center; padding: 40px; color: #666; width: 100%; grid-column: 1 / -1; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <!-- 1. 年齡確認視窗 -->
    <div id="age-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">未滿 18 歲請勿進入</div>
            <div class="modal-text">本網站包含部分成人或藝術裸露內容。<br>請確認您已年滿 18 歲。</div>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="confirmAge()">我已滿 18 歲 (Enter)</button>
                <button class="modal-btn secondary" onclick="exitSite()">未滿 18 歲 (Exit)</button>
            </div>
        </div>
    </div>

    <!-- 2. 加入主畫面教學視窗 (動態內容) -->
    <div id="pwa-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" id="pwa-title">獲得最佳瀏覽體驗</div>
            <!-- 內容會由 JS 根據裝置替換 -->
            <div id="pwa-instructions" class="modal-text"></div>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="dismissPWA()">我知道了</button>
                <button class="modal-btn secondary" onclick="dismissPWA(true)">不再顯示</button>
            </div>
        </div>
    </div>

    <header>
        <div id="back-btn" class="back-btn" onclick="goHome()">←</div>
        
        <h1 onclick="goHome()">
            <img src="kw_web_white_s.png" alt="Kylewengphoto攝情" class="site-logo" onerror="this.style.display='none'; document.getElementById('text-logo').style.display='block';">
            <span id="text-logo" class="fallback-title">Kylewengphoto攝情</span>
        </h1>

        <div id="social-links" class="social-links">
            <a href="https://www.facebook.com/kylewengphoto" target="_blank" class="social-icon" aria-label="Facebook">
                <svg viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385h-3.047v-3.47h3.047v-2.641c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953h-1.514c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385c5.737-.9 10.125-5.864 10.125-11.854z"/></svg>
            </a>
            <a href="https://www.instagram.com/kylewengphoto" target="_blank" class="social-icon" aria-label="Instagram">
                <svg viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
            </a>
        </div>
        
        <div id="category-tabs" class="category-tabs">
            <button class="tab-btn active" onclick="filterAlbums('all')">照片牆 Photo Wall</button>
            <button class="tab-btn" onclick="filterAlbums('portrait')">形象寫真</button>
            <button class="tab-btn" onclick="filterAlbums('event')">活動紀實</button>
        </div>
    </header>

    <div id="home-view" class="album-list"></div>
    <div id="gallery-view" class="gallery-view">
        <div id="gallery-grid" class="gallery-grid"></div>
    </div>

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox">
        <div class="close-btn" onclick="closeLightbox()">&times;</div>
        <div class="nav-btn prev" onclick="changePhoto(-1)">&#10094;</div>
        <div class="nav-btn next" onclick="changePhoto(1)">&#10095;</div>
        <div id="lightbox-content" class="lightbox-content"></div>
        <div class="action-bar">
            <a id="download-btn" href="#" target="_blank" class="btn" download>
                <span>↓</span> 下載原始檔 / Download Original
            </a>
            <p style="font-size: 12px; color: #ccc; margin: 8px 0 0 0; text-shadow: 0 1px 2px rgba(0,0,0,0.8); text-align: center;">手機請直接長按圖片儲存 / 電腦請點擊按鈕下載</p>
        </div>
    </div>

    <script>
        const API_KEY = 'f26141b4efcea9ac125fd95bf777eb55'; 
        const USER_ID = '135451339@N02'; 
        const SITE_TITLE = "Kylewengphoto攝情";

        const EVENT_KEYWORDS = [
            'Pride', 'Parade', 'Championship', 'Championshop', 
            'Day', '1st', '2nd', '3rd', '活動', '龍舟賽', '感恩會', 
            '晚會', '錦標賽', '競賽', '發表會', '遊行', '嘉年華', 
            '文化祭', '文化季', '角力', '田徑', '派對', '驕傲月', 
            '跨年', '法案', '現場', '音樂會', '小蜜蜂', '平權', 
            '國慶', '龍舟隊', '選拔', '練習', '屆', '路跑', '站出來'
        ];

        let cachedAlbums = [];
        let currentFilter = 'all';
        let currentAlbumPhotos = []; 
        let currentPhotoIndex = 0;
        let isAnimating = false;

        const homeView = document.getElementById('home-view');
        const galleryView = document.getElementById('gallery-view');
        const galleryGrid = document.getElementById('gallery-grid');
        const backBtn = document.getElementById('back-btn');
        const categoryTabs = document.getElementById('category-tabs');
        const socialLinks = document.getElementById('social-links');
        const ageModal = document.getElementById('age-modal');
        const pwaModal = document.getElementById('pwa-modal');
        const pwaInstructions = document.getElementById('pwa-instructions');
        const pwaTitle = document.getElementById('pwa-title');

        // ★ 功能 1: 年齡確認
        function checkAge() {
            const isVerified = localStorage.getItem('ageVerified');
            if (isVerified !== 'true') {
                ageModal.classList.add('active');
            } else {
                checkPWA();
            }
        }

        function confirmAge() {
            localStorage.setItem('ageVerified', 'true');
            ageModal.classList.remove('active');
            checkPWA();
        }

        function exitSite() {
            window.location.href = "https://www.google.com";
        }

        // ★ 功能 2: 自動裝置偵測 & PWA / In-App 提示
        function checkPWA() {
            const isDismissed = localStorage.getItem('pwaPromptDismissed');
            if (isDismissed === 'true') return;

            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
            if (isStandalone) return;

            // 判斷裝置與瀏覽器
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
            const isAndroid = /Android/.test(ua);
            
            // 偵測 In-App Browser (LINE, Instagram, Facebook)
            const isInApp = /Instagram|Line|FBAN|FBAV/i.test(ua);

            // 如果是電腦版 (非 iOS 也非 Android)，不顯示
            if (!isIOS && !isAndroid) return;

            // 準備 SVG 圖示
            // 分享圖示 (方塊+箭頭)
            const iconShare = `<svg class="inline-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line><polyline points="9 5 12 2 15 5"></polyline></svg>`;
            // 加號圖示 (方塊+加號)
            const iconPlus = `<svg class="inline-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="4" ry="4"></rect><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>`;
            // 選單圖示 (三點)
            const iconMenu = `<svg class="inline-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg>`;

            // 設定對應文案
            if (isInApp) {
                // 如果是 In-App Browser，提示跳轉
                pwaTitle.innerText = "建議使用系統瀏覽器";
                pwaInstructions.innerHTML = `
                    您目前正在使用 App 內建瀏覽器，<br>可能無法順利下載或加入主畫面。<br><br>
                    請點擊選單 ${iconMenu} 或分享圖示，<br>
                    並選擇 <b>「使用預設瀏覽器開啟」</b><br>
                    (如 Safari 或 Chrome)
                `;
            } else if (isIOS) {
                // iOS Safari
                pwaInstructions.innerHTML = `
                    將此網站加入主畫面，享受全螢幕體驗。<br><br>
                    1. 點擊下方工具列的 <b>分享</b> ${iconShare}<br>
                    2. 選擇 <b>加入主畫面</b> ${iconPlus}
                `;
            } else if (isAndroid) {
                // Android Chrome
                pwaInstructions.innerHTML = `
                    將此網站加入主畫面，享受全螢幕體驗。<br><br>
                    1. 點擊瀏覽器右上角選單 ${iconMenu}<br>
                    2. 選擇 <b>安裝應用程式</b> 或 <b>加入主畫面</b>
                `;
            }

            setTimeout(() => {
                pwaModal.classList.add('active');
            }, 1000);
        }

        function dismissPWA(forever = false) {
            pwaModal.classList.remove('active');
            if (forever) {
                localStorage.setItem('pwaPromptDismissed', 'true');
            } else {
                localStorage.setItem('pwaPromptDismissed', 'true'); 
            }
        }

        function safePushState(data, title, url) {
            try { window.history.pushState(data, title, url); } 
            catch (e) { console.warn('Preview mode: pushState disabled'); }
        }

        function init() {
            checkAge();
            const params = new URLSearchParams(window.location.search);
            const albumId = params.get('album');
            if (albumId) {
                loadAlbumPhotos(albumId);
            } else {
                filterAlbums('all');
            }
        }

        async function fetchPhotostream() {
            homeView.innerHTML = '<div class="loading">正在載入照片牆...</div>';
            homeView.style.display = ''; 
            homeView.className = 'photostream-mode'; 
            
            const url = `https://www.flickr.com/services/rest/?method=flickr.photos.search&api_key=${API_KEY}&user_id=${USER_ID}&sort=interestingness-desc&extras=url_q,url_m,url_l,url_o&per_page=100&format=json&nojsoncallback=1`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.stat !== 'ok') throw new Error(data.message);

                homeView.innerHTML = '';
                const photos = data.photos.photo;
                currentAlbumPhotos = [];

                photos.forEach((photo, index) => {
                    const thumbUrl = photo.url_m || photo.url_l || photo.url_q; 
                    const previewUrl = photo.url_l || photo.url_o;
                    const downloadUrl = photo.url_o || photo.url_l;
                    
                    if(!thumbUrl) return;

                    currentAlbumPhotos.push({
                        preview: previewUrl,
                        download: downloadUrl,
                        title: photo.title
                    });

                    const div = document.createElement('div');
                    div.className = 'stream-item';
                    div.innerHTML = `<img src="${thumbUrl}" class="stream-img" loading="lazy" onload="this.classList.add('loaded')">`;
                    
                    div.onclick = () => openLightbox(index); 
                    homeView.appendChild(div);
                });

            } catch (error) {
                console.error(error);
                homeView.innerHTML = `<div class="loading">載入失敗<br><small>${error.message}</small></div>`;
            }
        }

        async function fetchAlbumsAndRender(filterType) {
            homeView.className = 'album-list';
            homeView.style.display = 'flex'; 
            
            if (cachedAlbums.length > 0) {
                renderAlbumList(cachedAlbums.filter(album => album.type === filterType));
                return;
            }

            homeView.innerHTML = '<div class="loading">正在整理相簿...</div>';

            const url = `https://www.flickr.com/services/rest/?method=flickr.photosets.getList&api_key=${API_KEY}&user_id=${USER_ID}&primary_photo_extras=url_m,url_l,url_o&format=json&nojsoncallback=1`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.stat !== 'ok') throw new Error(data.message);

                cachedAlbums = data.photosets.photoset.map(set => {
                    const cover = set.primary_photo_extras?.url_l || set.primary_photo_extras?.url_m || set.primary_photo_extras?.url_o || '';
                    const title = set.title._content;
                    const desc = set.description._content || "（此相簿暫無描述）";
                    
                    let type = 'portrait';
                    if (EVENT_KEYWORDS.some(keyword => title.toLowerCase().includes(keyword.toLowerCase()))) {
                        type = 'event';
                    }

                    return { id: set.id, title: title, cover: cover, desc: desc, type: type };
                });

                renderAlbumList(cachedAlbums.filter(album => album.type === filterType));

            } catch (error) {
                console.error(error);
                homeView.innerHTML = `<div class="loading">載入失敗<br><small>${error.message}</small></div>`;
            }
        }

        function filterAlbums(type) {
            currentFilter = type;
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            if(type === 'all') buttons[0].classList.add('active');
            if(type === 'portrait') buttons[1].classList.add('active');
            if(type === 'event') buttons[2].classList.add('active');

            homeView.style.display = ''; 
            galleryView.style.display = 'none';
            backBtn.style.display = 'none';
            categoryTabs.style.display = 'flex';
            socialLinks.style.display = 'flex';

            if (type === 'all') {
                fetchPhotostream();
            } else {
                fetchAlbumsAndRender(type);
            }
        }

        function renderAlbumList(albums) {
            homeView.innerHTML = '';
            homeView.className = 'album-list';
            homeView.style.display = 'flex';

            if (albums.length === 0) {
                homeView.innerHTML = '<div class="loading">此分類暫無相簿</div>';
                return;
            }
            albums.forEach(album => {
                const coverImg = album.cover || 'https://placehold.co/600x400/333/FFF?text=No+Cover';
                
                const card = document.createElement('div');
                card.className = 'feed-card';
                card.innerHTML = `
                    <div class="feed-img-container" onclick="openAlbum('${album.id}')">
                        <img src="${coverImg}" class="feed-img" loading="lazy" alt="${album.title}">
                    </div>
                    <div class="feed-content">
                        <div class="feed-title">${album.title}</div>
                        <div class="feed-desc">${album.desc}</div>
                        <button class="enter-btn" onclick="openAlbum('${album.id}')">
                            查看完整相簿 &#10140;
                        </button>
                    </div>
                `;
                homeView.appendChild(card);
            });
        }

        window.openAlbum = function(id) {
            const newUrl = `?album=${id}`;
            safePushState({path: newUrl}, '', newUrl);
            loadAlbumPhotos(id);
        };

        async function loadAlbumPhotos(photosetId) {
            homeView.style.display = 'none';
            galleryView.style.display = 'block';
            backBtn.style.display = 'block';
            categoryTabs.style.display = 'none';
            socialLinks.style.display = 'none';
            galleryGrid.innerHTML = '<div class="loading">載入照片中...</div>';

            const url = `https://www.flickr.com/services/rest/?method=flickr.photosets.getPhotos&api_key=${API_KEY}&photoset_id=${photosetId}&user_id=${USER_ID}&extras=url_q,url_l,url_o&format=json&nojsoncallback=1`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.stat !== 'ok') throw new Error(data.message);

                galleryGrid.innerHTML = ''; 
                document.title = data.photoset.title + " | " + SITE_TITLE;
                
                currentAlbumPhotos = [];

                data.photoset.photo.forEach((photo, index) => {
                    const thumbUrl = photo.url_q || photo.url_m; 
                    const previewUrl = photo.url_l || photo.url_o || photo.url_m;
                    const downloadUrl = photo.url_o || photo.url_l;
                    
                    if(!thumbUrl) return;

                    currentAlbumPhotos.push({
                        preview: previewUrl,
                        download: downloadUrl,
                        title: photo.title
                    });

                    const div = document.createElement('div');
                    div.className = 'photo-item';
                    div.innerHTML = `<img src="${thumbUrl}" loading="lazy" onload="this.classList.add('loaded')">`;
                    
                    div.onclick = () => openLightbox(index);
                    galleryGrid.appendChild(div);
                });

            } catch (error) {
                console.error(error);
                galleryGrid.innerHTML = `<div class="loading">無法載入照片<br><small>${error.message}</small></div>`;
            }
        }

        function goHome() {
            const newUrl = window.location.pathname; 
            safePushState({path: newUrl}, '', newUrl);
            filterAlbums(currentFilter);
            document.title = SITE_TITLE;
        }

        // Lightbox Logic
        const lightbox = document.getElementById('lightbox');
        const lightboxContent = document.getElementById('lightbox-content');
        const downloadBtn = document.getElementById('download-btn');

        function openLightbox(index) {
            currentPhotoIndex = index;
            lightboxContent.innerHTML = ''; 
            renderLightboxPhoto(false); 
            lightbox.classList.add('active');
            document.body.style.overflow = 'hidden';
            isAnimating = false;
        }

        function renderLightboxPhoto(animate = false, direction = 1) {
            const photo = currentAlbumPhotos[currentPhotoIndex];
            downloadBtn.href = photo.download;

            const newImg = document.createElement('img');
            newImg.src = photo.preview;
            newImg.className = 'lightbox-img';
            newImg.draggable = false;
            
            if (animate) {
                isAnimating = true;
                newImg.classList.add(direction === 1 ? 'slide-next-enter' : 'slide-prev-enter');
                const oldImg = lightboxContent.querySelector('img');
                
                if (oldImg) {
                    oldImg.classList.add(direction === 1 ? 'slide-next-exit' : 'slide-prev-exit');
                    setTimeout(() => {
                        if(oldImg && oldImg.parentNode) oldImg.remove();
                        newImg.classList.remove('slide-next-enter', 'slide-prev-enter');
                        isAnimating = false;
                    }, 400); 
                } else {
                    isAnimating = false;
                }
                lightboxContent.appendChild(newImg);
            } else {
                lightboxContent.innerHTML = '';
                lightboxContent.appendChild(newImg);
            }
            preloadImage(currentPhotoIndex + 1);
            preloadImage(currentPhotoIndex - 1);
        }

        function preloadImage(index) {
            if (index >= 0 && index < currentAlbumPhotos.length) {
                const img = new Image();
                img.src = currentAlbumPhotos[index].preview;
            }
        }

        function changePhoto(direction) {
            if (isAnimating) return; 
            let newIndex = currentPhotoIndex + direction;
            if (newIndex < 0) return; 
            if (newIndex >= currentAlbumPhotos.length) return; 
            currentPhotoIndex = newIndex;
            renderLightboxPhoto(true, direction);
        }

        function closeLightbox() {
            lightbox.classList.remove('active');
            setTimeout(() => { lightboxContent.innerHTML = ''; }, 300);
            document.body.style.overflow = '';
        }

        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox || e.target === lightboxContent) closeLightbox();
        });

        let touchStartX = 0, touchEndX = 0, touchStartY = 0;
        lightbox.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }, {passive: true});
        lightbox.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            if (Math.abs(e.changedTouches[0].screenY - touchStartY) > 100) return;
            if (Math.abs(touchStartX - touchEndX) > 50) {
                (touchStartX - touchEndX > 0) ? changePhoto(1) : changePhoto(-1);
            }
        }, {passive: true});
        
        document.addEventListener('keydown', (e) => {
            if (!lightbox.classList.contains('active')) return;
            if (e.key === 'ArrowLeft') changePhoto(-1);
            if (e.key === 'ArrowRight') changePhoto(1);
            if (e.key === 'Escape') closeLightbox();
        });

        window.onpopstate = function(event) { init(); };

        init();
    </script>
</body>
</html>